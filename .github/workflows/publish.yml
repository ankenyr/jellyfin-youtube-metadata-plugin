name: "ðŸš€ Publish Plugin"
permissions:
  contents: write
on:
  release:
    types:
      - released
  workflow_dispatch:
jobs:
  build:
    uses: jellyfin/jellyfin-meta-plugins/.github/workflows/build.yaml@master
  upload:
    if: ${{ github.event_name == 'release' }}
    runs-on: ubuntu-latest
    needs:
      - build
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v6
        with:
          name: build-artifact
      - name: Prepare GitHub Release assets
        run: |-
          for file in ./*; do
            md5sum ${file#./} >> ${file%.*}.md5
            sha256sum ${file#./} >> ${file%.*}.sha256
          done
          ls -l
      - name: Upload GitHub Release assets
        uses: shogo82148/actions-upload-release-asset@v1.9.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./*

      - name: Checkout Source Repo
        uses: actions/checkout@v4
        with:
          path: source-repo
          sparse-checkout: |
            build.yaml

      - name: Checkout Manifest Repo
        uses: actions/checkout@v4
        with:
          repository: ankenyr/jellyfin-plugin-repo
          ref: master
          token: ${{ secrets.REPO_TOKEN }}
          path: manifest-repo

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Update Manifest
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          REPO_NAME: ${{ github.repository }}
        run: |
          pip install pyyaml
          
          cat <<EOF > update_manifest.py
          import os
          import json
          import hashlib
          import datetime
          import sys
          import yaml

          def calculate_md5(filepath):
              md5_hash = hashlib.md5()
              with open(filepath, "rb") as f:
                  for byte_block in iter(lambda: f.read(4096), b""):
                      md5_hash.update(byte_block)
              return md5_hash.hexdigest()

          def main():
              print("Starting manifest update...")
              if not os.path.exists('source-repo/build.yaml'):
                  print("Error: source-repo/build.yaml not found")
                  sys.exit(1)
                  
              with open('source-repo/build.yaml', 'r') as f:
                  build_data = yaml.safe_load(f)
              
              version = str(build_data.get('version'))
              guid = build_data.get('guid')
              
              tag_name = os.environ.get('RELEASE_TAG')
              if tag_name:
                  if tag_name.lstrip('v') != version:
                      print(f"Error: Release tag {tag_name} does not match build.yaml version {version}")
                      sys.exit(1)
              else:
                  tag_name = f"v{version}"
              
              zip_filename = f"youtube-metadata_{version}.zip"
              # Check in current dir
              if not os.path.exists(zip_filename):
                  zips = [f for f in os.listdir('.') if f.endswith('.zip')]
                  if zips:
                      zip_filename = zips[0]
                      print(f"Using found zip: {zip_filename}")
                  else:
                      print(f"No zip file found for version {version}")
                      sys.exit(1)
              
              checksum = calculate_md5(zip_filename)
              
              repo_name = os.environ.get('REPO_NAME')
                  
              source_url = f"https://github.com/{repo_name}/releases/download/{tag_name}/{zip_filename}"
              
              manifest_path = 'manifest-repo/manifest.json'
              with open(manifest_path, 'r') as f:
                  manifest = json.load(f)
              
              entry = next((item for item in manifest if item['guid'] == guid), None)
              if not entry:
                  print(f"GUID {guid} not found in manifest")
                  sys.exit(1)
              
              new_version = {
                  "version": version,
                  "changelog": build_data.get('changelog', ''),
                  "targetAbi": str(build_data.get('targetAbi', '')),
                  "sourceUrl": source_url,
                  "checksum": checksum,
                  "timestamp": datetime.datetime.now(datetime.timezone.utc).strftime('%Y-%m-%dT%H:%M:%SZ')
              }
              
              # Remove existing if same version to allow re-runs
              entry['versions'] = [v for v in entry['versions'] if v['version'] != version]
              entry['versions'].insert(0, new_version)
              
              with open(manifest_path, 'w') as f:
                  json.dump(manifest, f, indent=4)

          if __name__ == "__main__":
              main()
          EOF
          
          python update_manifest.py

      - name: Commit and Push Manifest
        working-directory: manifest-repo
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add manifest.json
          git commit -m "Update manifest for ${{ github.event.release.tag_name }}"
          git push
